<!doctype html>

<head>
  <meta charset="UTF-8">
  <title>vaadin-nav tests</title>
  <script src="../../web-component-tester/browser.js"></script>
  <script src="../../iron-test-helpers/mock-interactions.js"></script>
  <link rel="import" href="../vaadin-nav-item.html">
  <link rel="import" href="../vaadin-nav.html">
</head>

<body>
  <test-fixture id="nav">
    <template>
      <vaadin-nav style="width: 400px; height: 400px;">
        <vaadin-nav-item>Foo</vaadin-nav-item>
        <vaadin-nav-item>Bar</vaadin-nav-item>
        <separator>___</separator>
        <vaadin-nav-item disabled>Baz</vaadin-nav-item>
        <vaadin-nav-item>Baz</vaadin-nav-item>
      </vaadin-nav>
    </template>
  </test-fixture>
  <script>
    const safari10 = /Apple.* Version\/(9|10)/.test(navigator.userAgent);

    function arrowDown(target) {
      MockInteractions.keyDownOn(target, 40, [], 'ArrowDown');
    }

    function arrowRight(target) {
      MockInteractions.keyDownOn(target, 39, [], 'ArrowRight');
    }

    function arrowRightIE(target) {
      MockInteractions.keyDownOn(target, 39, [], 'Right');
    }

    function arrowUp(target) {
      MockInteractions.keyDownOn(target, 38, [], 'ArrowUp');
    }

    function arrowLeft(target) {
      MockInteractions.keyDownOn(target, 37, [], 'ArrowLeft');
    }

    function home(target) {
      MockInteractions.keyDownOn(target, 36, [], 'Home');
    }

    function end(target) {
      MockInteractions.keyDownOn(target, 35, [], 'End');
    }

    function keyDownChar(target, letter, modifier) {
      MockInteractions.keyDownOn(target, letter.charCodeAt(0), modifier, letter);
    }

    describe('vaadin-nav', () => {
      var nav;

      beforeEach(() => nav = fixture('nav'));

      it('should have a correct localName', () => {
        expect(nav.localName).to.equal('vaadin-nav');
      });

      it('should have role="tablist"', () => {
        expect(nav.getAttribute('role')).to.equal('tablist');
      });

      it('`_navItems` should only contain vaadin-nav-items', () => {
        expect(nav._navItems.length).to.equal(4);
        nav._navItems.forEach(item => {
          expect(item.tagName.toLowerCase()).to.equal('vaadin-nav-item');
        });
      });

      it('should not have attribute overflow when items fit in the viewport', function(done) {
        setTimeout(() => {
          expect(nav.hasAttribute('overflow')).to.be.false;
          done();
        }, 1);
      });

      describe('Overflow', () => {

        [false, true].forEach(isVertical => {
          beforeEach(() => nav.vertical = true);

          describe('In large viewport', () => {
            it(`when vertical=${isVertical} should not have overflow`, function(done) {
              setTimeout(() => {
                expect(nav.hasAttribute('overflow')).to.be.false;
                done();
              }, 10);
            });
          });

          // FIXME: these tests pass in latest Safari but fails in previous version
          describe('In small viewport', () => {
            if (safari10) {
              return;
            }

            beforeEach(() => {
              nav.style.width = nav.style.height = '100px';
              nav._updateOverflow();
            });

            it(`when vertical=${isVertical} should have overflow="end" if scroll is at the beginning`, done => {
              setTimeout(() => {
                expect(nav.getAttribute('overflow')).to.be.equal('end');
                done();
              }, 10);
            });

            it(`when vertical=${isVertical} should have overflow="start end" if scroll is at the middle`, done => {
              nav._incrementScroll(2);
              setTimeout(() => {
                expect(nav.getAttribute('overflow')).to.be.equal('start end');
                done();
              }, 10);
            });

            it(`when vertical=${isVertical} should have overflow="start" if scroll is at the end`, function(done) {
              nav._incrementScroll(400);
              setTimeout(() => {
                expect(nav.getAttribute('overflow')).to.be.equal('start');
                done();
              }, 10);
            });
          });

        });
      });

      describe('vaadin-nav-list-mixin', () => {
        beforeEach(() => nav._focus(0));

        it('should select first item by default', () => {
          expect(nav._navItems[0].selected).to.be.true;
        });

        it('select an item when `selected` property is set', () => {
          nav.selected = 2;
          expect(nav._navItems[2].selected).to.be.true;
        });

        it('should move focus to next element on "arrow-right" keydown', () => {
          arrowRight(nav);
          expect(nav._navItems[1].focused).to.be.true;
        });

        it('should move focus when event.key name does not include the Arrow prefix (IE)', () => {
          arrowRightIE(nav);
          expect(nav._navItems[1].focused).to.be.true;
        });

        it('should move focus to prev element on "arrow-left" keydown', () => {
          arrowRight(nav);
          arrowLeft(nav);
          expect(nav._navItems[0].focused).to.be.true;
        });

        it('should move focus to next element on "arrow-down" keydown', () => {
          nav.vertical = true;
          arrowDown(nav);
          expect(nav._navItems[1].focused).to.be.true;
        });

        it('should move focus to prev element on "arrow-up" keydown', () => {
          nav.vertical = true;
          arrowDown(nav);
          arrowUp(nav);
          expect(nav._navItems[0].focused).to.be.true;
        });

        it('should move focus to first element on "home" keydown', () => {
          nav._focus(3);
          home(nav);
          expect(nav._navItems[0].focused).to.be.true;
        });

        it('should move focus to second element if first is disabled on "home" keydown', () => {
          nav._navItems[0].disabled = true;
          nav._focus(3);
          home(nav);
          expect(nav._navItems[1].focused).to.be.true;
        });

        it('should move focus to last element on "end" keydown', () => {
          end(nav);
          expect(nav._navItems[3].focused).to.be.true;
        });

        it('should move focus to the most closed enabled element if last is disabled on "end" keydown', () => {
          nav._navItems[3].disabled = true;
          end(nav);
          expect(nav._navItems[1].focused).to.be.true;
        });

        it('if focus is in last element should move focus to first element on arrow-right', () => {
          nav._focus(nav._navItems.length - 1);
          arrowRight(nav);
          expect(nav._navItems[0].focused).to.be.true;
        });

        it('if focus is in first element should move focus to last element on arrow-left', () => {
          arrowLeft(nav);
          expect(nav._navItems[nav._navItems.length - 1].focused).to.be.true;
        });

        it('focus loop should skip disabled items', () => {
          arrowRight(nav);
          arrowRight(nav);
          expect(nav._navItems[3].focused).to.be.true;
        });

        it('should focus the next item whose first letter matches the key pressed', () => {
          keyDownChar(nav, 'b');
          expect(nav._navItems[1].focused).to.be.true;
        });

        it('key search should be case insensitive', () => {
          keyDownChar(nav, 'B');
          expect(nav._navItems[1].focused).to.be.true;
        });

        it('key search should not happen if a modifier key is pressed', () => {
          keyDownChar(nav, 'b', 'shift');
          expect(nav._navItems[0].focused).to.be.true;
        });

        it('key search should skip disabled items', () => {
          keyDownChar(nav, 'b');
          keyDownChar(nav, 'b');
          expect(nav._navItems[3].focused).to.be.true;
        });

        it('focus should loop when search by first letter', () => {
          nav._focus(nav._navItems.length - 1);
          keyDownChar(nav, 'b');
          expect(nav._navItems[1].focused).to.be.true;
        });
      });
    });
  </script>
</body>
